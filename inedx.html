<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flappy Bird — With Score Animation</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{display:flex;align-items:center;justify-content:center;background:linear-gradient(#87CEEB,#cfefff);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{width:420px}
    canvas{display:block;width:100%;height:auto;border:6px solid #333;border-radius:8px;background:#70c5ce}
    .info{margin-top:12px;text-align:center}
    .btn{display:inline-block;padding:8px 12px;margin:4px;border-radius:6px;background:#333;color:#fff;text-decoration:none;cursor:pointer}
    .small{font-size:14px;color:#222}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="420" height="580"></canvas>
    <div class="info">
      <div id="score" class="small">Score: 0</div>
      <div style="margin-top:6px">
        <button id="startBtn" class="btn">Start / Restart</button>
        <button id="muteBtn" class="btn">Mute</button>
      </div>
      <div class="small" style="margin-top:8px;color:#111">Space / Click / Tap to flap</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const startBtn = document.getElementById('startBtn');
    const muteBtn = document.getElementById('muteBtn');

    const W = canvas.width;
    const H = canvas.height;

    let frames = 0;
    let gameState = 'menu';
    let pipes = [];
    let gravity = 0.55;
    let pipeGap = 140;
    let pipeWidth = 60;
    let spawnInterval = 110;
    let score = 0;
    let best = Number(localStorage.getItem('flappy_best') || 0);
    let muted = false;

    // --- Score burst particles ---
    let bursts = []; // {x,y,radius,life,color}

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioCtx ? new AudioCtx() : null;
    function playBeep(freq, time=0.06, vol=0.02){
      if(muted || !audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(freq, audioCtx.currentTime);
      g.gain.setValueAtTime(vol, audioCtx.currentTime);
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + time);
    }

    const bird = {
      x: 90,
      y: H/2,
      w: 34,
      h: 24,
      vel: 0,
      rot: 0,
      flapPower: -9,
      wingTimer: 0,
      reset(){ this.y = H/2; this.vel = 0; this.rot = 0; this.wingTimer = 0 },
      flap(){ this.vel = this.flapPower; this.wingTimer = 6; playBeep(880,0.03) },
      update(){
        this.vel += gravity;
        this.y += this.vel;
        this.rot = Math.max(-0.9, Math.min(1.4, this.vel/10));
        if(this.wingTimer>0) this.wingTimer--;
      },
      draw(){
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rot);
        ctx.fillStyle = '#FFDD57';
        ctx.beginPath();
        ctx.ellipse(0,0,this.w/2,this.h/2,0,0,Math.PI*2);
        ctx.fill();
        ctx.save();
        const wingOffset = this.wingTimer>0 ? -6 : -2;
        ctx.translate(-2, 4);
        ctx.rotate(wingOffset * Math.PI/180);
        ctx.beginPath();
        ctx.ellipse(-6,0,10,5,0,0,Math.PI*2);
        ctx.fillStyle = '#e6b800';
        ctx.fill();
        ctx.restore();
        ctx.fillStyle='#111';
        ctx.beginPath();
        ctx.arc(6,-3,3,0,Math.PI*2);
        ctx.fill();
        ctx.restore();
      }
    };

    class Pipe{
      constructor(){
        this.x = W + 10;
        const margin = 60;
        const top = Math.floor(Math.random() * (H - pipeGap - margin*2)) + margin;
        this.top = top;
        this.w = pipeWidth;
        this.passed = false;
        this.speed = 2.4 + Math.min(1.6, Math.floor(frames/1000)*0.1);
      }
      update(){ this.x -= this.speed }
      draw(){
        ctx.fillStyle = '#229954';
        ctx.fillRect(this.x, 0, this.w, this.top);
        ctx.fillRect(this.x, this.top + pipeGap, this.w, H - (this.top + pipeGap));
        ctx.fillStyle = '#1b5e35';
        ctx.fillRect(this.x - 4, this.top - 8, this.w + 8, 8);
        ctx.fillRect(this.x - 4, this.top + pipeGap, this.w + 8, 8);
      }
    }

    function resetGame(){
      frames = 0; pipes = []; score = 0; bursts = [];
      bird.reset(); gameState = 'menu';
      scoreEl.textContent = 'Score: 0 (Best: ' + best + ')';
    }

    function startGame(){
      pipes = []; frames = 0; score = 0; bursts = [];
      bird.reset(); gameState = 'playing';
      scoreEl.textContent = 'Score: 0 (Best: ' + best + ')';
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }

    function gameOver(){
      gameState = 'over'; playBeep(120,0.2);
      if(score>best){ best = score; localStorage.setItem('flappy_best', String(best)); }
    }

    function flap(){
      if(gameState === 'menu') startGame();
      else if(gameState === 'over') resetGame();
      if(gameState === 'playing') bird.flap();
    }

    canvas.addEventListener('mousedown', e => { flap(); });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); flap(); }, {passive:false});
    window.addEventListener('keydown', e => { if(e.code === 'Space') { e.preventDefault(); flap(); } });

    startBtn.addEventListener('click', ()=>{ if(gameState==='playing') resetGame(); else startGame(); });
    muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted ? 'Unmute' : 'Mute' });

    function rectsCollide(ax,ay,aw,ah, bx,by,bw,bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function createBurst(x, y){
      for(let i=0;i<12;i++){
        bursts.push({
          x, y,
          radius: 4 + Math.random()*3,
          angle: Math.random()*Math.PI*2,
          speed: 2 + Math.random()*2,
          life: 30,
          color: `hsl(${Math.random()*360},80%,60%)`
        });
      }
    }

    function updateBursts(){
      for(let i=bursts.length-1;i>=0;i--){
        const b = bursts[i];
        b.x += Math.cos(b.angle)*b.speed;
        b.y += Math.sin(b.angle)*b.speed;
        b.radius *= 0.96;
        b.life--;
        if(b.life<=0) bursts.splice(i,1);
      }
    }

    function drawBursts(){
      for(const b of bursts){
        ctx.fillStyle = b.color;
        ctx.beginPath();
        ctx.arc(b.x,b.y,b.radius,0,Math.PI*2);
        ctx.fill();
      }
    }

    function update(){
      frames++;
      if(gameState === 'playing'){
        if(frames % spawnInterval === 0){ pipes.push(new Pipe()); }
        for(let i=pipes.length-1;i>=0;i--){
          const p = pipes[i];
          p.update();
          if(!p.passed && p.x + p.w < bird.x - bird.w/2){
            p.passed = true;
            score++;
            scoreEl.textContent = 'Score: ' + score + ' (Best: ' + best + ')';
            playBeep(600,0.03);
            createBurst(bird.x, bird.y); // <-- new burst
          }
          if(p.x + p.w < -20) pipes.splice(i,1);
          if(rectsCollide(bird.x - bird.w/2, bird.y - bird.h/2, bird.w, bird.h, p.x, 0, p.w, p.top)) gameOver();
          if(rectsCollide(bird.x - bird.w/2, bird.y - bird.h/2, bird.w, bird.h, p.x, p.top + pipeGap, p.w, H - (p.top + pipeGap))) gameOver();
        }
        bird.update();
        if(bird.y + bird.h/2 >= H - 6){ bird.y = H - bird.h/2 - 6; gameOver(); }
        if(bird.y - bird.h/2 <= 0){ bird.y = bird.h/2; bird.vel = 0 }
        updateBursts();
      }
    }

    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = 'rgba(255,255,255,0.6)';
      const cloudX = (frames*0.2) % (W+120) - 60;
      ctx.beginPath(); ctx.ellipse(cloudX,80,60,24,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cloudX+80,100,40,18,0,0,Math.PI*2); ctx.fill();

      ctx.fillStyle = '#8B5A2B';
      ctx.fillRect(0,H-40,W,40);
      ctx.fillStyle = '#6b3f1b';
      ctx.fillRect(0,H-40,W,8);

      for(const p of pipes) p.draw();

      bird.draw();
      drawBursts(); // draw particles

      ctx.fillStyle = '#fff';
      ctx.font = '20px system-ui';
      if(gameState === 'menu'){
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(30,120,W-60,160);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.font = '24px system-ui';
        ctx.fillText('Flappy — Click/Space to flap', W/2, 170);
        ctx.font = '16px system-ui';
        ctx.fillText('Press Start or tap to begin', W/2, 210);
        ctx.font = '14px system-ui';
        ctx.fillText('Best: ' + best, W/2, 250);
        ctx.textAlign = 'left';
      }

      if(gameState === 'over'){
        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.fillRect(40,140,W-80,140);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.font = '28px system-ui';
        ctx.fillText('Game Over', W/2, 190);
        ctx.font = '16px system-ui';
        ctx.fillText('Score: ' + score, W/2, 230);
        ctx.fillText('Best: ' + best, W/2, 255);
        ctx.fillText('Click Start to play again', W/2, 285);
        ctx.textAlign = 'left';
      }
    }

    function loop(){ update(); draw(); requestAnimationFrame(loop); }

    resetGame(); loop();
  </script>
</body>
</html>
